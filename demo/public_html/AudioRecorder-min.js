"use strict";function AudioRecorder(){}window.AudioContext=window.AudioContext||window.webkitAudioContext,AudioRecorder.prototype={ismobile:!1,debug:!1,autodetect:!0,currentVolume:0,isRecording:!1,isSpeaking:!1,audioContext:null,leftChannel:[],recordingLength:0,microphone:null,processor:null,ready:!1,config:{sampleRate:44100,bufferLen:4096,numChannels:1,mimeType:"audio/webm"},volume:{threshold:.3,raw:0,slow:0,clip:0},vol:0,ave:0,isSafari:function e(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)},checkForMobile:function e(){var t=["desktop"],i=!0;if(window.device)for(var n=0;n<t.length;n++){var o=void 0;o=new RegExp(t[n],"i"),window.document.documentElement.className.match(o)&&(i=!1)}else i="ontouchstart"in window;i?(this.ismobile=!0,this.trace("mobile browser detected")):(this.ismobile=!1,this.trace("desktop browser detected"))},init:function e(){this.checkForMobile(),this.trace("init")},trace:function e(t){this.debug&&console.log(t)},analyzer:function e(t){var i=t.createAnalyser();i.fftSize=256,this.microphone.connect(i);var n=i.frequencyBinCount,o=new Uint8Array(n)},onAudioProcess:function e(t){var i=this,n=t.inputBuffer.getChannelData(0);this.recordingLength+=this.config.bufferLen,this.leftChannel.push(new Float32Array(n));var o=0,r,s=0;for(r=0;r<n.length;++r)o+=n[r]*n[r],Math.abs(n[r])>.99&&(s+=1);var a=1;this.isSafari()&&(a=.094),this.ismobile&&!isSafari()&&(a=.0094),this.vol=Math.sqrt(o/n.length)*a,this.volume.raw=(100*this.vol).toFixed(3),this.ave=.95*this.ave+.05*this.vol,this.volume.slow=(100*this.ave).toFixed(3),this.volume.clip=s/n.length,this.volume.slow>this.volume.threshold?(this.isSpeaking=!0,clearTimeout(this.speakingTimeout)):this.isSpeaking&&(this.isSpeaking=!1,clearTimeout(this.speakingTimeout),this.speakingTimeout=setTimeout(function(){i.autodetect&&i.stopRecording()},500)),this.callback_onProgress()},enableMicrophone:function e(){this.ready||this.startRecording(!0)},startRecording:function e(t){var i=this;this.audioContext=new AudioContext,this.ready=!t,this.audioContext.createJavaScriptNode?this.processor=this.audioContext.createJavaScriptNode(this.config.bufferLen,this.config.numChannels,this.config.numChannels):this.audioContext.createScriptProcessor?this.processor=this.audioContext.createScriptProcessor(this.config.bufferLen,this.config.numChannels,this.config.numChannels):console.log("WebAudio API has no support on this browser."),this.processor.connect(this.audioContext.destination),navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(this.gotStreamMethod.bind(this)).catch(function(e){i.callback_micFailure(e)})},getBuffers:function e(t){for(var i=[],n=0;n<2;++n)i[n]=t.inputBuffer.getChannelData(n);return i},gotStreamMethod:function e(t){var i=this;if(this.ready&&(this.isRecording=!0),this.tracks=t.getTracks(),this.microphone=this.audioContext.createMediaStreamSource(t),this.microphone.connect(this.processor),!this.ready)return this.audioContext.close(),this.processor.disconnect(),this.tracks.forEach(function(e){return e.stop()}),this.ready=!0,void this.callback_micSuccess();this.processor.onaudioprocess=function(e){i.onAudioProcess(e)},this.analyzer(this.audioContext),this.callback_startRecording()},clearRecordedData:function e(){this.recordingLength=0,this.leftChannel=[]},stopRecording:function e(){var t=this;this.isRecording&&(this.isRecording=!1,this.audioContext.close(),this.processor.disconnect(),this.tracks.forEach(function(e){return e.stop()}),this.mergeLeftRightBuffers({sampleRate:this.config.sampleRate,numberOfAudioChannels:this.config.numChannels,internalInterleavedLength:this.recordingLength,leftBuffers:this.leftChannel,rightBuffers:1===this.config.numChannels?[]:rightChannel},function(e,i){t.blob=new Blob([i],{type:"audio/webm;codecs=opus"}),t.buffer=new ArrayBuffer(i.buffer.byteLength),t.view=i,t.sampleRate=t.config.sampleRate,t.bufferSize=t.config.bufferLen,t.length=t.recordingLength,t.callback_stopRecording(t.blob),t.clearRecordedData()}))},processInWebWorker:function e(t){var i=URL.createObjectURL(new Blob([t.toString(),";this.onmessage =  function (e) {"+t.name+"(e.data);}"],{type:"application/javascript"})),n=new Worker(i);return n.workerURL=i,n},callback_stopRecording:function e(t){this.trace("------------------------- callback_stopRecording"),this.trace(t)},callback_startRecording:function e(){this.trace("------------------------- callback_startRecording")},callback_threshold:function e(){this.trace("------------------------- callback_threshold")},callback_micSuccess:function e(){this.trace("------------------------- callback_micSuccess")},callback_micFailure:function e(t){alert("callback_micFailure:\n"+t)},callback_onProgress:function e(){},mergeLeftRightBuffers:function e(t,i){function n(e,t){function i(e,t,i){var o=Math.round(e.length*(t/i)),r=[],s=Number((e.length-1)/(o-1));r[0]=e[0];for(var a=1;a<o-1;a++){var c=a*s,h=Number(Math.floor(c)).toFixed(),u=Number(Math.ceil(c)).toFixed(),l=c-h;r[a]=n(e[h],e[u],l)}return r[o-1]=e[e.length-1],r}function n(e,t,i){return e+(t-e)*i}function o(e,t){for(var i=new Float64Array(t),n=0,o=e.length,r=0;r<o;r++){var s=e[r];i.set(s,n),n+=s.length}return i}function r(e,t){for(var i=e.length+t.length,n=new Float64Array(i),o=0,r=0;r<i;)n[r++]=e[o],n[r++]=t[o],o++;return n}function s(e,t,i){for(var n=i.length,o=0;o<n;o++)e.setUint8(t+o,i.charCodeAt(o))}var a=e.numberOfAudioChannels,c=e.leftBuffers.slice(0),h=e.rightBuffers.slice(0),u=e.sampleRate,l=e.internalInterleavedLength,f=e.desiredSampRate;2===a&&(c=o(c,l),h=o(h,l),f&&(c=i(c,f,u),h=i(h,f,u))),1===a&&(c=o(c,l),f&&(c=i(c,f,u))),f&&(u=f);var d;2===a&&(d=r(c,h)),1===a&&(d=c);var g=d.length,m=44+2*g,b=new ArrayBuffer(m),p=new DataView(b);s(p,0,"RIFF"),p.setUint32(4,44+2*g,!0),s(p,8,"WAVE"),s(p,12,"fmt "),p.setUint32(16,16,!0),p.setUint16(20,1,!0),p.setUint16(22,a,!0),p.setUint32(24,u,!0),p.setUint32(28,2*u,!0),p.setUint16(32,2*a,!0),p.setUint16(34,16,!0),s(p,36,"data"),p.setUint32(40,2*g,!0);for(var v=g,w=44,k=1,R=0;R<v;R++)p.setInt16(w,32767*d[R],!0),w+=2;if(t)return t({buffer:b,view:p});postMessage({buffer:b,view:p})}var o=this.processInWebWorker(n);o.onmessage=function(e){i(e.data.buffer,e.data.view),URL.revokeObjectURL(o.workerURL)},o.postMessage(t)},getAudioData:function e(){return this.blob}};